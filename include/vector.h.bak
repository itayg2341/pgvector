#ifdef __cplusplus
extern "C" {
#endif

#ifndef VECTOR_H
#define VECTOR_H

#include "postgres.h"
#include <stddef.h>

#ifdef __cplusplus
constexpr int16 VECTOR_MAX_DIM = 16000;
#else
#define VECTOR_MAX_DIM 16000
#endif

// Define a layout struct for C and for offsetof in C++
struct VectorLayout {
    int32vl_len_;
    int16dim;
    int16unused;
    floatx[FLEXIBLE_ARRAY_MEMBER];
};

static inline size_t
VECTOR_SIZE(int16 dim)
{
    return offsetof(struct VectorLayout, x) + sizeof(float) * dim;
}

#ifdef __cplusplus
class Vector {
    int32vl_len_;
    int16dim;
    int16unused;
    floatx[FLEXIBLE_ARRAY_MEMBER];

public:
    static Vector *Init(int dim);
    voidPrint(char *msg);
    intCmp(Vector * b);

    int16 get_dim() const { return dim; }
    int16 get_unused() const { return unused; }
    float *get_x() { return x; }
    const float *get_x() const { return x; }
    Vector *operator+(const Vector &other) const;
    Vector *operator-(const Vector &other) const;
    float operator*(const Vector &other) const;
};
#else
#define Vector VectorLayout
#endif

static inline Vector *
DatumGetVector(Datum x)
{
    return (Vector *) PG_DETOAST_DATUM(x);
}

static inline Vector *
PG_GETARG_VECTOR_P(int x)
{
    return DatumGetVector(PG_GETARG_DATUM(x));
}

#define PG_RETURN_VECTOR_P(x)PG_RETURN_POINTER(x)

/* TODO Move to better place */
#if PG_VERSION_NUM >= 160000
#define FUNCTION_PREFIX
#else
#define FUNCTION_PREFIX PGDLLEXPORT
#endif

#endif

#ifdef __cplusplus
}
#endif
